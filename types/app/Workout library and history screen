// app/(tabs)/workouts.tsx - Workout library and history screen

import React, { useState } from 'react'
import {
  View,
  Text,
  ScrollView,
  TouchableOpacity,
  TextInput,
  FlatList,
} from 'react-native'
import { useDispatch, useSelector } from 'react-redux'
import { router } from 'expo-router'
import { startWorkout } from '@/state/slices/workoutSlice'

type TabType = 'templates' | 'history' | 'programs'

export default function WorkoutsScreen() {
  const [activeTab, setActiveTab] = useState<TabType>('templates')
  const [searchQuery, setSearchQuery] = useState('')

  return (
    <View className="flex-1 bg-dark-900">
      {/* Header */}
      <View className="bg-dark-700 px-6 py-4 border-b border-dark-50">
        <Text className="text-dark-50 text-3xl font-bold mb-4">Workouts</Text>
        
        {/* Search Bar */}
        <View className="bg-dark-900 rounded-xl px-4 py-3 flex-row items-center mb-4">
          <Text className="text-dark-700 mr-3">üîç</Text>
          <TextInput
            value={searchQuery}
            onChangeText={setSearchQuery}
            placeholder="Search workouts..."
            placeholderTextColor="#6B7280"
            className="flex-1 text-dark-50"
          />
        </View>

        {/* Tabs */}
        <View className="flex-row gap-2">
          <TabButton
            title="Templates"
            active={activeTab === 'templates'}
            onPress={() => setActiveTab('templates')}
          />
          <TabButton
            title="History"
            active={activeTab === 'history'}
            onPress={() => setActiveTab('history')}
          />
          <TabButton
            title="Programs"
            active={activeTab === 'programs'}
            onPress={() => setActiveTab('programs')}
          />
        </View>
      </View>

      {/* Content */}
      <ScrollView className="flex-1 p-6">
        {activeTab === 'templates' && <TemplatesTab searchQuery={searchQuery} />}
        {activeTab === 'history' && <HistoryTab searchQuery={searchQuery} />}
        {activeTab === 'programs' && <ProgramsTab searchQuery={searchQuery} />}
      </ScrollView>

      {/* Quick Start FAB */}
      <TouchableOpacity
        onPress={() => router.push('/create-workout')}
        className="absolute bottom-6 right-6 bg-primary-500 w-16 h-16 rounded-full items-center justify-center shadow-lg"
        style={{
          shadowColor: '#10B981',
          shadowOffset: { width: 0, height: 4 },
          shadowOpacity: 0.3,
          shadowRadius: 8,
          elevation: 8,
        }}
      >
        <Text className="text-white text-3xl font-bold">+</Text>
      </TouchableOpacity>
    </View>
  )
}

// Tab Button Component
function TabButton({ title, active, onPress }: any) {
  return (
    <TouchableOpacity
      onPress={onPress}
      className={`flex-1 py-3 rounded-lg ${
        active ? 'bg-primary-500' : 'bg-dark-900'
      }`}
    >
      <Text
        className={`text-center font-semibold ${
          active ? 'text-white' : 'text-dark-700'
        }`}
      >
        {title}
      </Text>
    </TouchableOpacity>
  )
}

// Templates Tab
function TemplatesTab({ searchQuery }: { searchQuery: string }) {
  const dispatch = useDispatch()

  // Sample workout templates
  const templates: WorkoutSession[] = [
    {
      id: '1',
      userId: 'user1',
      name: 'Upper Body Power',
      description: 'Focus on compound movements for upper body strength',
      status: 'planned',
      exercises: [
        {
          id: 'ex1',
          exerciseId: 'bench-press',
          order: 1,
          sets: [
            { id: 's1', setNumber: 1, type: 'warmup', targetReps: 10, targetWeight: 60, completed: false },
            { id: 's2', setNumber: 2, type: 'working', targetReps: 8, targetWeight: 80, completed: false },
            { id: 's3', setNumber: 3, type: 'working', targetReps: 6, targetWeight: 90, completed: false },
          ],
          exercise: {
            id: 'bench-press',
            name: 'Barbell Bench Press',
            description: 'Classic chest exercise',
            category: 'strength',
            muscleGroups: ['chest', 'shoulders', 'arms'],
            equipment: ['barbell'],
            difficulty: 'intermediate',
            instructions: ['Lie on bench', 'Lower bar to chest', 'Press up'],
            isCustom: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
        },
        {
          id: 'ex2',
          exerciseId: 'rows',
          order: 2,
          sets: [
            { id: 's4', setNumber: 1, type: 'working', targetReps: 10, targetWeight: 70, completed: false },
            { id: 's5', setNumber: 2, type: 'working', targetReps: 10, targetWeight: 70, completed: false },
            { id: 's6', setNumber: 3, type: 'working', targetReps: 10, targetWeight: 70, completed: false },
          ],
          exercise: {
            id: 'rows',
            name: 'Barbell Rows',
            description: 'Back thickness builder',
            category: 'strength',
            muscleGroups: ['back'],
            equipment: ['barbell'],
            difficulty: 'intermediate',
            instructions: ['Bend at hips', 'Pull bar to torso', 'Lower with control'],
            isCustom: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
        },
      ],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
    {
      id: '2',
      userId: 'user1',
      name: 'Leg Day',
      description: 'Complete lower body workout',
      status: 'planned',
      exercises: [
        {
          id: 'ex3',
          exerciseId: 'squats',
          order: 1,
          sets: [
            { id: 's7', setNumber: 1, type: 'warmup', targetReps: 10, targetWeight: 60, completed: false },
            { id: 's8', setNumber: 2, type: 'working', targetReps: 8, targetWeight: 100, completed: false },
            { id: 's9', setNumber: 3, type: 'working', targetReps: 6, targetWeight: 120, completed: false },
          ],
          exercise: {
            id: 'squats',
            name: 'Barbell Back Squat',
            description: 'King of leg exercises',
            category: 'strength',
            muscleGroups: ['legs', 'glutes', 'core'],
            equipment: ['barbell'],
            difficulty: 'intermediate',
            instructions: ['Bar on back', 'Squat down', 'Drive through heels'],
            isCustom: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
        },
      ],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
    {
      id: '3',
      userId: 'user1',
      name: 'Quick HIIT',
      description: '20-minute high intensity workout',
      status: 'planned',
      exercises: [
        {
          id: 'ex4',
          exerciseId: 'burpees',
          order: 1,
          sets: [
            { id: 's10', setNumber: 1, type: 'amrap', targetDuration: 60, completed: false },
            { id: 's11', setNumber: 2, type: 'amrap', targetDuration: 60, completed: false },
            { id: 's12', setNumber: 3, type: 'amrap', targetDuration: 60, completed: false },
          ],
          exercise: {
            id: 'burpees',
            name: 'Burpees',
            description: 'Full body cardio exercise',
            category: 'cardio',
            muscleGroups: ['full-body'],
            equipment: ['bodyweight'],
            difficulty: 'intermediate',
            instructions: ['Drop to ground', 'Push up', 'Jump up'],
            isCustom: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          },
        },
      ],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    },
  ]

  const filteredTemplates = templates.filter(workout =>
    workout.name.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const handleStartWorkout = (workout: WorkoutSession) => {
    dispatch(startWorkout(workout))
    router.push('/active-workout')
  }

  return (
    <View>
      <View className="flex-row justify-between items-center mb-4">
        <Text className="text-dark-50 text-xl font-bold">Workout Templates</Text>
        <Text className="text-dark-700 text-sm">{filteredTemplates.length} templates</Text>
      </View>

      {filteredTemplates.map((workout) => (
        <WorkoutCard
          key={workout.id}
          workout={workout}
          onStart={() => handleStartWorkout(workout)}
        />
      ))}

      {filteredTemplates.length === 0 && (
        <View className="items-center py-12">
          <Text className="text-dark-700 text-center mb-2">No templates found</Text>
          <Text className="text-dark-700 text-center text-sm">
            Try a different search or create a new workout
          </Text>
        </View>
      )}
    </View>
  )
}

// History Tab
function HistoryTab({ searchQuery }: { searchQuery: string }) {
  const { workouts } = useSelector((state: any) => state.workout)

  const completedWorkouts = workouts.filter(
    (w: WorkoutSession) => w.status === 'completed'
  )

  const filteredWorkouts = completedWorkouts.filter((workout: WorkoutSession) =>
    workout.name.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)

    if (date.toDateString() === today.toDateString()) {
      return 'Today'
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Yesterday'
    } else {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    }
  }

  return (
    <View>
      <View className="flex-row justify-between items-center mb-4">
        <Text className="text-dark-50 text-xl font-bold">Workout History</Text>
        <Text className="text-dark-700 text-sm">{filteredWorkouts.length} workouts</Text>
      </View>

      {filteredWorkouts.length > 0 ? (
        filteredWorkouts.map((workout: WorkoutSession) => (
          <TouchableOpacity
            key={workout.id}
            className="bg-dark-700 rounded-2xl p-5 mb-4"
            onPress={() => router.push(`/workout-details/${workout.id}`)}
          >
            <View className="flex-row justify-between items-start mb-3">
              <View className="flex-1">
                <Text className="text-dark-50 text-lg font-bold mb-1">
                  {workout.name}
                </Text>
                {workout.completedAt && (
                  <Text className="text-dark-700 text-sm">
                    {formatDate(workout.completedAt)}
                  </Text>
                )}
              </View>
              {workout.rating && (
                <View className="bg-primary-500/20 px-3 py-1 rounded-full">
                  <Text className="text-primary-500 font-semibold">
                    {'‚≠ê'.repeat(workout.rating)}
                  </Text>
                </View>
              )}
            </View>

            <View className="flex-row gap-4">
              {workout.duration && (
                <View>
                  <Text className="text-dark-700 text-xs mb-1">Duration</Text>
                  <Text className="text-dark-50 font-semibold">
                    {Math.floor(workout.duration / 60)}m
                  </Text>
                </View>
              )}
              {workout.totalVolume && (
                <View>
                  <Text className="text-dark-700 text-xs mb-1">Volume</Text>
                  <Text className="text-dark-50 font-semibold">
                    {workout.totalVolume.toLocaleString()} kg
                  </Text>
                </View>
              )}
              <View>
                <Text className="text-dark-700 text-xs mb-1">Exercises</Text>
                <Text className="text-dark-50 font-semibold">
                  {workout.exercises.length}
                </Text>
              </View>
            </View>
          </TouchableOpacity>
        ))
      ) : (
        <View className="items-center py-12">
          <Text className="text-6xl mb-4">üí™</Text>
          <Text className="text-dark-700 text-center mb-2">No workouts yet</Text>
          <Text className="text-dark-700 text-center text-sm">
            Complete your first workout to see it here
          </Text>
        </View>
      )}
    </View>
  )
}

// Programs Tab
function ProgramsTab({ searchQuery }: { searchQuery: string }) {
  const { programs, activeProgram } = useSelector((state: any) => state.workout)

  return (
    <View>
      <View className="flex-row justify-between items-center mb-4">
        <Text className="text-dark-50 text-xl font-bold">Training Programs</Text>
      </View>

      {activeProgram && (
        <View className="bg-primary-500/10 border-2 border-primary-500 rounded-2xl p-5 mb-4">
          <View className="flex-row items-center mb-2">
            <Text className="text-primary-500 text-xs font-bold uppercase mr-2">
              Active Program
            </Text>
          </View>
          <Text className="text-dark-50 text-xl font-bold mb-2">
            {activeProgram.name}
          </Text>
          <Text className="text-dark-700 mb-4">{activeProgram.description}</Text>
          <TouchableOpacity className="bg-primary-500 rounded-lg py-3 items-center">
            <Text className="text-white font-semibold">Continue Program</Text>
          </TouchableOpacity>
        </View>
      )}

      <View className="items-center py-12">
        <Text className="text-6xl mb-4">üìã</Text>
        <Text className="text-dark-700 text-center mb-2">Programs Coming Soon</Text>
        <Text className="text-dark-700 text-center text-sm px-12">
          Follow structured training programs to reach your goals faster
        </Text>
      </View>
    </View>
  )
}

// Workout Card Component
function WorkoutCard({ workout, onStart }: any) {
  const totalSets = workout.exercises.reduce(
    (sum: number, ex: any) => sum + ex.sets.length,
    0
  )

  const muscleGroups = Array.from(
    new Set(
      workout.exercises.flatMap((ex: any) => ex.exercise?.muscleGroups || [])
    )
  )

  return (
    <View className="bg-dark-700 rounded-2xl p-5 mb-4">
      <Text className="text-dark-50 text-xl font-bold mb-2">{workout.name}</Text>
      {workout.description && (
        <Text className="text-dark-700 mb-4">{workout.description}</Text>
      )}

      {muscleGroups.length > 0 && (
        <View className="flex-row flex-wrap gap-2 mb-4">
          {muscleGroups.slice(0, 3).map((muscle: string) => (
            <View key={muscle} className="bg-primary-500/20 px-3 py-1 rounded-full">
              <Text className="text-primary-500 text-xs font-semibold capitalize">
                {muscle}
              </Text>
            </View>
          ))}
        </View>
      )}

      <View className="flex-row justify-between items-center mb-4">
        <View>
          <Text className="text-dark-700 text-xs mb-1">Exercises</Text>
          <Text className="text-dark-50 font-semibold">
            {workout.exercises.length}
          </Text>
        </View>
        <View>
          <Text className="text-dark-700 text-xs mb-1">Total Sets</Text>
          <Text className="text-dark-50 font-semibold">{totalSets}</Text>
        </View>
        <View>
          <Text className="text-dark-700 text-xs mb-1">Est. Time</Text>
          <Text className="text-dark-50 font-semibold">
            {totalSets * 2}-{totalSets * 3}m
          </Text>
        </View>
      </View>

      <TouchableOpacity
        onPress={onStart}
        className="bg-primary-500 rounded-xl py-4 items-center"
      >
        <Text className="text-white font-bold">Start Workout</Text>
      </TouchableOpacity>
    </View>
  )
}
